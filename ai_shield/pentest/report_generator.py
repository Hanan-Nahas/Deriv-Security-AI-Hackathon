"""Generate markdown and HTML reports for pentest executions."""

from __future__ import annotations

import html
import logging
from datetime import datetime
from pathlib import Path
from typing import List

from ai_shield.pentest.vulnerability_analyzer import VulnerabilityRecord

logger = logging.getLogger(__name__)


class ReportGenerator:
    """Create report artifacts for security reviews."""

    def generate_markdown(self, records: List[VulnerabilityRecord], summary: dict) -> str:
        """Build a markdown report string."""
        heatmap = self._severity_heatmap(records)
        blocked_events = sum(1 for record in records if record.blocked)
        unblocked_events = len(records) - blocked_events
        lines = [
            "# Deriv AI Shield Pentest Report",
            "",
            f"Generated: {datetime.utcnow().isoformat()}Z",
            "",
            "## Summary",
            f"- Overall vulnerability score: **{summary.get('overall_score', 0.0)}**",
            f"- Blocked attack rate: **{summary.get('blocked_rate', 0.0)}**",
            f"- Critical findings: **{summary.get('critical_findings', 0)}**",
            f"- Total tests: **{summary.get('total_tests', 0)}**",
            f"- Blocked events: **{blocked_events}**",
            f"- Unblocked events: **{unblocked_events}**",
            "",
            "## Severity Heatmap",
            heatmap,
            "",
            "## Findings",
            "| Category | Severity | Blocked | Vulnerability Score | Payload |",
            "|---|---:|:---:|---:|---|",
        ]
        for record in records:
            lines.append(
                f"| {record.category} | {record.severity} | {record.blocked} | {record.vulnerability_score} | {record.payload} |"
            )
        return "\n".join(lines)

    def generate_html(self, markdown_report: str) -> str:
        """Build a minimal HTML report wrapper from markdown plaintext."""
        escaped = html.escape(markdown_report)
        return (
            "<html><head><title>Deriv AI Shield Report</title></head>"
            "<body><h1>Deriv AI Shield Pentest Report</h1>"
            f"<pre>{escaped}</pre></body></html>"
        )

    def generate_pdf(self, markdown_report: str, output_path: str) -> str:
        """Generate a PDF report from markdown content."""
        try:
            from reportlab.lib import colors
            from reportlab.lib.pagesizes import letter
            from reportlab.lib.styles import getSampleStyleSheet
            from reportlab.platypus import Paragraph, SimpleDocTemplate, Spacer, Table, TableStyle

            styles = getSampleStyleSheet()
            title_style = styles["Title"]
            header_style = styles["Heading2"]
            body_style = styles["BodyText"]

            elements = []
            table_rows = []
            in_table = False

            for raw_line in markdown_report.splitlines():
                line = raw_line.strip()
                if not line:
                    if in_table and table_rows:
                        elements.append(self._build_table(table_rows))
                        table_rows = []
                        in_table = False
                    elements.append(Spacer(1, 12))
                    continue

                if line.startswith("# "):
                    elements.append(Paragraph(line[2:], title_style))
                    continue
                if line.startswith("## "):
                    if in_table and table_rows:
                        elements.append(self._build_table(table_rows))
                        table_rows = []
                        in_table = False
                    elements.append(Paragraph(line[3:], header_style))
                    continue
                if line.startswith("|") and line.endswith("|"):
                    in_table = True
                    cells = [cell.strip() for cell in line.strip("|").split("|")]
                    if cells and not all(set(cell) <= {"-"} for cell in cells):
                        table_rows.append(cells)
                    continue

                if in_table and table_rows:
                    elements.append(self._build_table(table_rows))
                    table_rows = []
                    in_table = False

                if line.startswith("- "):
                    elements.append(Paragraph(f"â€¢ {line[2:]}", body_style))
                else:
                    elements.append(Paragraph(line, body_style))

            if in_table and table_rows:
                elements.append(self._build_table(table_rows))

            doc = SimpleDocTemplate(output_path, pagesize=letter)
            doc.build(elements)
            return output_path
        except Exception as exc:  # pragma: no cover
            logger.exception("Failed to generate PDF: %s", exc)
            return ""

    def save_reports(self, markdown_report: str, html_report: str, output_dir: str = "reports") -> dict:
        """Persist markdown and HTML reports to disk."""
        try:
            Path(output_dir).mkdir(parents=True, exist_ok=True)
            timestamp = datetime.utcnow().strftime("%Y%m%d_%H%M%S")
            md_path = Path(output_dir) / f"pentest_report_{timestamp}.md"
            html_path = Path(output_dir) / f"pentest_report_{timestamp}.html"
            pdf_path = Path(output_dir) / f"pentest_report_{timestamp}.pdf"
            md_path.write_text(markdown_report, encoding="utf-8")
            html_path.write_text(html_report, encoding="utf-8")
            pdf_output = self.generate_pdf(markdown_report, str(pdf_path))
            logger.info("Saved reports: %s and %s", md_path, html_path)
            return {"markdown": str(md_path), "html": str(html_path), "pdf": pdf_output}
        except Exception as exc:  # pragma: no cover
            logger.exception("Failed to save reports: %s", exc)
            return {"markdown": "", "html": "", "pdf": ""}

    @staticmethod
    def _severity_heatmap(records: List[VulnerabilityRecord]) -> str:
        buckets = {1: 0, 2: 0, 3: 0, 4: 0, 5: 0}
        for record in records:
            buckets[record.severity] = buckets.get(record.severity, 0) + 1
        lines = ["| Severity | Count |", "|---:|---:|"]
        for severity in sorted(buckets):
            lines.append(f"| {severity} | {buckets[severity]} |")
        return "\n".join(lines)

    @staticmethod
    def _build_table(rows: List[List[str]]) -> Table:
        """Create a styled reportlab table from parsed markdown rows."""
        from reportlab.lib import colors

        table = Table(rows, hAlign="LEFT")
        table.setStyle(
            TableStyle(
                [
                    ("BACKGROUND", (0, 0), (-1, 0), colors.HexColor("#e2e8f0")),
                    ("TEXTCOLOR", (0, 0), (-1, 0), colors.HexColor("#111827")),
                    ("GRID", (0, 0), (-1, -1), 0.5, colors.HexColor("#94a3b8")),
                    ("FONTNAME", (0, 0), (-1, 0), "Helvetica-Bold"),
                    ("FONTNAME", (0, 1), (-1, -1), "Helvetica"),
                    ("FONTSIZE", (0, 0), (-1, -1), 9),
                    ("VALIGN", (0, 0), (-1, -1), "TOP"),
                ]
            )
        )
        return table

